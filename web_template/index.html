<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Hearthfield</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #1a1a2e;
            overscroll-behavior: none;
            touch-action: none;
        }

        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas#game-canvas {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1a1a2e;
            color: #e0d6c2;
            font-family: system-ui, sans-serif;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        #loading h1 {
            font-size: 2em;
            margin-bottom: 0.5em;
            letter-spacing: 0.05em;
        }

        #loading-bar-bg {
            width: 60%;
            max-width: 300px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        #loading-bar {
            width: 0%;
            height: 100%;
            background: #7eb356;
            border-radius: 4px;
            transition: width 0.3s;
        }

        #loading-text {
            margin-top: 0.5em;
            font-size: 0.9em;
            opacity: 0.7;
        }

        .hidden { opacity: 0; pointer-events: none; }

        /* Error overlay */
        #error-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(20, 10, 30, 0.95);
            color: #ff6b6b;
            font-family: monospace;
            font-size: 13px;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        #error-overlay h2 {
            color: #ff6b6b;
            margin-bottom: 10px;
            font-size: 16px;
        }
        #error-overlay .error-msg {
            background: #1a0a2e;
            border: 1px solid #ff6b6b44;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
            word-wrap: break-word;
            white-space: pre-wrap;
            color: #ffaaaa;
        }
        #error-overlay .hint {
            color: #aaa;
            margin-top: 12px;
            font-size: 12px;
        }

        @supports (-webkit-touch-callout: none) {
            html, body { height: -webkit-fill-available; }
            #game-container { height: -webkit-fill-available; }
        }
    </style>
</head>
<body>
    <div id="loading">
        <h1>Hearthfield</h1>
        <div id="loading-bar-bg"><div id="loading-bar"></div></div>
        <p id="loading-text">Loading...</p>
    </div>

    <div id="game-container">
        <canvas id="game-canvas"></canvas>
    </div>

    <div id="error-overlay">
        <h2>Hearthfield Error</h2>
        <div id="error-messages"></div>
        <p class="hint">Screenshot this and share for debugging.<br>
        Try refreshing or opening on a desktop browser.</p>
    </div>

    <script>
        // Error capture (runs before anything else)
        const errorOverlay = document.getElementById('error-overlay');
        const errorMessages = document.getElementById('error-messages');
        let errorCount = 0;

        function showError(msg) {
            errorCount++;
            if (errorCount > 20) return;
            errorOverlay.style.display = 'block';
            const div = document.createElement('div');
            div.className = 'error-msg';
            div.textContent = msg;
            errorMessages.appendChild(div);
        }

        const origError = console.error;
        console.error = function() {
            origError.apply(console, arguments);
            const msg = Array.from(arguments).map(a =>
                typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)
            ).join(' ');
            showError(msg);
        };

        window.addEventListener('error', (e) => {
            showError('JS Error: ' + e.message + '\n  at ' + e.filename + ':' + e.lineno);
        });

        window.addEventListener('unhandledrejection', (e) => {
            const reason = e.reason;
            let msg = 'Unhandled rejection: ';
            if (reason instanceof Error) {
                msg += reason.message + '\n' + (reason.stack || '');
            } else if (typeof reason === 'string') {
                msg += reason;
            } else {
                msg += JSON.stringify(reason);
            }
            showError(msg);
        });
    </script>

    <script type="module">
        const loadingBar = document.getElementById('loading-bar');
        const loadingText = document.getElementById('loading-text');
        const loadingScreen = document.getElementById('loading');

        loadingText.textContent = 'Downloading game...';
        loadingBar.style.width = '10%';

        try {
            loadingText.textContent = 'Importing module...';
            loadingBar.style.width = '20%';
            const module = await import('./hearthfield.js');

            loadingText.textContent = 'Compiling WASM...';
            loadingBar.style.width = '40%';

            const timeout = new Promise((_, reject) =>
                setTimeout(() => reject(new Error('WASM initialization timed out (60s). Your device may not support this game.')), 60000)
            );

            loadingText.textContent = 'Starting Bevy engine...';
            loadingBar.style.width = '50%';

            await Promise.race([module.default(), timeout]);

            loadingBar.style.width = '100%';
            loadingText.textContent = 'Ready!';
            setTimeout(() => loadingScreen.classList.add('hidden'), 300);
        } catch (err) {
            loadingText.textContent = 'Error: ' + err.message;
            loadingBar.style.background = '#c44';
            loadingBar.style.width = '100%';
            console.error('Hearthfield load failed:', err);

            const hint = document.createElement('p');
            hint.style.cssText = 'margin-top:1em;font-size:0.8em;opacity:0.6;max-width:80%;text-align:center;';
            hint.textContent = 'Try refreshing, or open on a desktop browser. Mobile devices may have memory limitations with large WASM games.';
            loadingScreen.appendChild(hint);
        }

        // Prevent iOS Safari gestures
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('gesturechange', e => e.preventDefault());
        document.addEventListener('gestureend', e => e.preventDefault());

        // iOS audio unlock
        let audioUnlocked = false;
        function unlockAudio() {
            if (audioUnlocked) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const buf = ctx.createBuffer(1, 1, 22050);
            const src = ctx.createBufferSource();
            src.buffer = buf;
            src.connect(ctx.destination);
            src.start(0);
            audioUnlocked = true;
            document.removeEventListener('touchstart', unlockAudio);
            document.removeEventListener('click', unlockAudio);
        }
        document.addEventListener('touchstart', unlockAudio, { once: true });
        document.addEventListener('click', unlockAudio, { once: true });
    </script>
</body>
</html>
